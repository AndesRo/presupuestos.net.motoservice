<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuestos</title>
    
    <!-- Meta tags PWA -->
    <meta name="theme-color" content="#208090">
    <meta name="description" content="Genera presupuestos profesionales">
    <meta name="application-name" content="Presupuestos">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Presupuestos">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Favicon y icons PWA -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTYgMEM3LjE3MyAwIDAgNy4xNzMgMCAxNlM3LjE3MyAzMiAxNiAzMmM4LjgyNyAwIDE2LTcuMTczIDE2LTE2UzI0LjgyNyAwIDE2IDB6IiBmaWxsPSIjMjA4MDkwIi8+PHBhdGggZD0iTTIxLjUgMTEuNUwxNi41IDZsLTUgNS41TDE2IDE3bC0zIDMtMi0yIDUtNSAzIDMgNS41LTUuNXoiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">
    <link rel="icon" type="image/png" sizes="16x16" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNOCAwQzMuNTgyIDAgMCAzLjU4MiAwIDhzMy41ODIgOCA4IDggOC0zLjU4MiA4LThTMTIuNDE4IDAgOCAweiIgZmlsbD0iIzIwODA5MCIvPjxwYXRoIGQ9Ik0xMC43NSA1Ljc1TDguMjUgM2wtMi41IDIuNzVMMCA3LjVsMS41IDEuNSAyLTIgMS41IDEuNSAyLjc1LTIuNzV6IiBmaWxsPSIjZmZmZmZmIi8+PC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTk2IDBDNDIuOTgxIDAgMCA0Mi45ODEgMCA5NnM0Mi45ODEgOTYgOTYgOTYgOTYtNDIuOTgxIDk2LTk2UzE0OS4wMTkgMCA5NiAweiIgZmlsbD0iIzIwODA5MCIvPjxwYXRoIGQ9Ik0xMjkgNzFMMTAyIDQ4bC0yNyAyM0w4NCAxMDFsLTE4IDE4LTEyLTEyIDMwLTMwIDE4IDE4IDMzLTI4eiIgZmlsbD0iI2ZmZmZmZiIvPjwvc3ZnPg==">
    <link rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTYgMEM3LjE3MyAwIDAgNy4xNzMgMCAxNlM3LjE3MyAzMiAxNiAzMmM4LjgyNyAwIDE2LTcuMTczIDE2LTE2UzI0LjgyNyAwIDE2IDB6IiBmaWxsPSIjMjA4MDkwIi8+PHBhdGggZD0iTTIxLjUgMTEuNUwxNi41IDZsLTUgNS41TDE2IDE3bC0zIDMtMi0yIDUtNSAzIDMgNS41LTUuNXoiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlByZXN1cHVlc3RvcyIsCiAgInNob3J0X25hbWUiOiAiUHJlc3VwdWVzdG9zIiwKICAiZGVzY3JpcHRpb24iOiAiR2VuZXJhIHByZXN1cHVlc3RvcyBwcm9mZXNpb25hbGVzIHBhcmEgU0VSVkkgQUdSTyB5IFNFUlZJIE1PVE8gTU9MSU5BIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMyMDgwOTAiLAogICJ0aGVtZV9jb2xvciI6ICIjMjA4MDkwIiwKICAib3JpZW50YXRpb24iOiAiYW55IiwKICAic2NvcGUiOiAiLiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIZHBaSFJvUFNJeU5qQWlJR2hsYVdkb2REMGlNVEF5SWlCb1pXbG5hSFE5SWpFd01DSWdkbWxsZDBKdmVEMGlNVEV3SlRJZ01UQTVJajRtSTNoaE96d3ZjM1puSwp9Igp9">
    <link rel="stylesheet" href="/estilos.css">
    <!-- Incluir jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    
</head>
<body>
    <!-- Banner de estado offline -->
    <div id="offlineStatus" class="offline-status">
        ‚ö†Ô∏è Est√°s trabajando sin conexi√≥n. Los datos se guardar√°n localmente.
    </div>
    
    <!-- Bot√≥n de instalaci√≥n PWA -->
    <button id="installButton" class="install-button">
        üì± Instalar App
    </button>

    <div class="container">
        <header>
            <div class="header-left">
                <h1>üìäMIS PRESUPUESTOS</h1>
                <p class="subtitle">Genera presupuestos de manera Profesional</p>
            </div>
            <div class="business-selector">
                <div class="business-badge" id="currentBusiness">
                    SERVI AGRO
                </div>
            </div>
        </header>

        <div class="layout">
            <!-- Panel Izquierdo: Formulario -->
            <div class="panel">
                <div class="section-title">Seleccionar Raz√≥n Social</div>
                <div class="business-options">
                    <button class="business-btn active" onclick="cambiarRazonSocial('serviagro')">
                        SERVI AGRO
                    </button>
                    <button class="business-btn" onclick="cambiarRazonSocial('servimoto')">
                        SERVI MOTO MOLINA
                    </button>
                </div>

                <div class="section-title">Datos de la Empresa</div>
                <div class="form-group">
                    <label>Empresa / Tu Negocio</label>
                    <input type="text" id="empresaNombre" placeholder="ej: Tech Solutions SpA">
                </div>
                <div class="form-group">
                    <label>RUT / Identificaci√≥n</label>
                    <input type="text" id="empresaRut" placeholder="ej: 12.345.678-9">
                </div>
                <div class="form-group">
                    <label>Direcci√≥n</label>
                    <input type="text" id="empresaDireccion" placeholder="ej: Av. Principal 123, Santiago">
                </div>
                <div class="form-group">
                    <label>Email / Tel√©fono</label>
                    <input type="text" id="empresaContacto" placeholder="ej: contacto@empresa.com">
                </div>

                <div class="section-title" style="margin-top: 20px;">Datos del Cliente</div>
                <div class="form-group">
                    <label>Nombre Cliente</label>
                    <input type="text" id="clienteNombre" placeholder="ej: Juan Garc√≠a">
                </div>
                <div class="form-group">
                    <label>Empresa Cliente</label>
                    <input type="text" id="clienteEmpresa" placeholder="ej: ABC Ltda.">
                </div>
                <div class="form-group">
                    <label>Direcci√≥n / Ubicaci√≥n</label>
                    <input type="text" id="clienteDireccion" placeholder="ej: Av. Principal 123, Santiago">
                </div>
                <div class="form-group">
                    <label>Email / Tel√©fono</label>
                    <input type="text" id="clienteContacto" placeholder="ej: cliente@empresa.com">
                </div>

                <div class="section-title" style="margin-top: 20px;">Agregar Items</div>
                <div class="form-group">
                    <label>Descripci√≥n del Servicio/Producto</label>
                    <input type="text" id="itemDescripcion" placeholder="ej: servicios,repuestos,etc.">
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="itemCantidad" placeholder="1" min="1" value="1">
                </div>
                <div class="form-group">
                    <label>Valor Unitario (CLP)</label>
                    <input type="number" id="itemValor" placeholder="0" min="0" step="1000">
                </div>
                <button class="btn btn-primary" onclick="agregarItem()">+ Agregar Item</button>

                <!-- Secci√≥n de items recientes -->
                <div id="recentItems" class="recent-items" style="display: none;">
                    <div class="recent-items-title">Items Recientes (click para usar):</div>
                    <div id="recentItemsList"></div>
                </div>

                <button class="btn btn-danger" onclick="limpiarFormulario()">Limpiar Presupuesto</button>
            </div>

            <!-- Panel Derecho: Preview -->
            <div class="panel">
                <div class="section-title">Vista Previa del Presupuesto</div>
                
                <div id="successMessage" class="success-message" style="display: none;"></div>

                <div id="budgetPreview">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>Completa los datos para generar el presupuesto</p>
                    </div>
                </div>

                <button class="btn btn-export" onclick="generarPDF()">üì• Descargar PDF</button>
                <button class="btn btn-export" onclick="imprimirPresupuesto()" style="background: #3498db;">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
    </div>

    <!-- Contenedor oculto para impresi√≥n -->
    <div id="printableBudget" class="print-only"></div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;

        // Variables PWA
        let deferredPrompt;
        let isOnline = navigator.onLine;

        // Datos predefinidos de las razones sociales
        const razonesSociales = {
            serviagro: {
                nombre: "SERVI AGRO",
                rut: "13.156.369-8",
                direccion: "QUECHEREGUAS 2356, MOLINA, Chile",
                contacto: "servimotomolina@gmail.com - +56 9 1234 5678"
            },
            servimoto: {
                nombre: "SERVI MOTO MOLINA",
                rut: "13.156.369-8",
                direccion: "QUECHEREGUAS 2356, Molina, Chile",
                contacto: "servimotomolina@gmail.com - +56 9 8765 4321"
            }
        };

        // Almacenamiento de datos
        const storage = {
            empresa: razonesSociales.serviagro, // Por defecto Servi-Agro
            cliente: { 
                nombre: '', 
                empresa: '', 
                direccion: '',
                contacto: '' 
            },
            items: [],
            ultimoNumeroPresupuesto: 230,
            itemsRecientes: [],
            razonSocialActual: 'serviagro'
        };

        // ========== FUNCIONALIDADES PWA ==========

        // Detectar cambios en la conectividad
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const offlineStatus = document.getElementById('offlineStatus');
            
            if (!isOnline) {
                offlineStatus.classList.add('show');
                mostrarMensajeExito('‚ö†Ô∏è Modo offline activado. Los datos se guardar√°n localmente.');
            } else {
                offlineStatus.classList.remove('show');
                mostrarMensajeExito('‚úÖ Conexi√≥n restaurada.');
            }
        }

        // Registrar Service Worker para funcionalidad offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker instalado');
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        console.log('Service Worker activado');
                        event.waitUntil(clients.claim());
                    });

                    self.addEventListener('fetch', (event) => {
                        // Podemos agregar estrategias de cach√© aqu√≠ si es necesario
                        event.respondWith(fetch(event.request));
                    });
                `))
                .then(registration => {
                    console.log('Service Worker registrado con √©xito:', registration.scope);
                })
                .catch(error => {
                    console.log('Error al registrar Service Worker:', error);
                });
            });
        }

        // Manejar la instalaci√≥n de la PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que el navegador muestre el prompt autom√°ticamente
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar bot√≥n de instalaci√≥n
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.classList.add('show');
                
                installButton.addEventListener('click', () => {
                    // Mostrar el prompt de instalaci√≥n
                    deferredPrompt.prompt();
                    
                    // Esperar a que el usuario responda al prompt
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Usuario acept√≥ la instalaci√≥n');
                            mostrarMensajeExito('‚úÖ Aplicaci√≥n instalada correctamente');
                        } else {
                            console.log('Usuario rechaz√≥ la instalaci√≥n');
                        }
                        deferredPrompt = null;
                        installButton.classList.remove('show');
                    });
                });
            }
        });

        // Detectar si la app ya est√° instalada
        window.addEventListener('appinstalled', () => {
            console.log('Aplicaci√≥n instalada');
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.classList.remove('show');
            }
            deferredPrompt = null;
        });

        // Verificar si ya est√° instalada
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
            console.log('Aplicaci√≥n ya instalada');
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.classList.remove('show');
            }
        }

        // Event listeners para estado de conexi√≥n
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Inicializar estado de conexi√≥n
        updateOnlineStatus();

        // ========== FUNCIONALIDADES DE LA APLICACI√ìN ==========

        // Funci√≥n para cambiar raz√≥n social
        function cambiarRazonSocial(razon) {
            // Actualizar botones
            document.querySelectorAll('.business-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (razon === 'serviagro') {
                document.querySelector('.business-btn:nth-child(1)').classList.add('active');
                document.getElementById('currentBusiness').textContent = 'SERVI AGRO';
            } else {
                document.querySelector('.business-btn:nth-child(2)').classList.add('active');
                document.getElementById('currentBusiness').textContent = 'SERVI MOTO MOLINA';
            }

            // Actualizar datos
            storage.empresa = razonesSociales[razon];
            storage.razonSocialActual = razon;
            
            // Actualizar campos del formulario
            actualizarCamposEmpresa();
            guardarDatos();
            actualizarPreview();
            
            mostrarMensajeExito(`‚úì Cambiado a ${razonesSociales[razon].nombre}`);
        }

        // Actualizar campos del formulario con datos de la empresa
        function actualizarCamposEmpresa() {
            document.getElementById('empresaNombre').value = storage.empresa.nombre;
            document.getElementById('empresaRut').value = storage.empresa.rut;
            document.getElementById('empresaDireccion').value = storage.empresa.direccion;
            document.getElementById('empresaContacto').value = storage.empresa.contacto;
        }

        // Cargar datos del localStorage
        function cargarDatos() {
            const datos = localStorage.getItem('presupuestoData');
            if (datos) {
                const guardados = JSON.parse(datos);
                Object.assign(storage, guardados);
                actualizarUI();
                mostrarItemsRecientes();
            }
        }

        // Guardar datos
        function guardarDatos() {
            localStorage.setItem('presupuestoData', JSON.stringify(storage));
            
            // Si estamos online, podr√≠amos sincronizar con un servidor aqu√≠
            if (isOnline) {
                // Opcional: sincronizar con backend
                console.log('Datos guardados localmente, listos para sincronizaci√≥n online');
            }
        }

        // Actualizar UI con datos cargados
        function actualizarUI() {
            // Actualizar bot√≥n activo
            document.querySelectorAll('.business-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (storage.razonSocialActual === 'serviagro') {
                document.querySelector('.business-btn:nth-child(1)').classList.add('active');
                document.getElementById('currentBusiness').textContent = 'SERVI AGRO';
            } else {
                document.querySelector('.business-btn:nth-child(2)').classList.add('active');
                document.getElementById('currentBusiness').textContent = 'SERVI MOTO MOLINA';
            }

            // Actualizar campos
            actualizarCamposEmpresa();
            
            document.getElementById('clienteNombre').value = storage.cliente.nombre || '';
            document.getElementById('clienteEmpresa').value = storage.cliente.empresa || '';
            document.getElementById('clienteDireccion').value = storage.cliente.direccion || '';
            document.getElementById('clienteContacto').value = storage.cliente.contacto || '';
            actualizarPreview();
        }

        // Configurar event listeners
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
            
            // Permitir edici√≥n manual de campos de empresa
            document.getElementById('empresaNombre').addEventListener('change', (e) => {
                storage.empresa.nombre = e.target.value;
                guardarDatos();
                actualizarPreview();
            });
            document.getElementById('empresaRut').addEventListener('change', (e) => {
                storage.empresa.rut = e.target.value;
                guardarDatos();
                actualizarPreview();
            });
            document.getElementById('empresaDireccion').addEventListener('change', (e) => {
                storage.empresa.direccion = e.target.value;
                guardarDatos();
                actualizarPreview();
            });
            document.getElementById('empresaContacto').addEventListener('change', (e) => {
                storage.empresa.contacto = e.target.value;
                guardarDatos();
            });
            
            // Datos de cliente
            document.getElementById('clienteNombre').addEventListener('change', (e) => {
                storage.cliente.nombre = e.target.value;
                guardarDatos();
                actualizarPreview();
            });
            document.getElementById('clienteEmpresa').addEventListener('change', (e) => {
                storage.cliente.empresa = e.target.value;
                guardarDatos();
                actualizarPreview();
            });
            document.getElementById('clienteDireccion').addEventListener('change', (e) => {
                storage.cliente.direccion = e.target.value;
                guardarDatos();
                actualizarPreview();
            });
            document.getElementById('clienteContacto').addEventListener('change', (e) => {
                storage.cliente.contacto = e.target.value;
                guardarDatos();
            });
        });

        function agregarItem() {
            const desc = document.getElementById('itemDescripcion').value.trim();
            const cant = parseInt(document.getElementById('itemCantidad').value) || 1;
            const val = parseFloat(document.getElementById('itemValor').value) || 0;

            if (!desc) {
                alert('Por favor ingresa una descripci√≥n del item');
                return;
            }

            const item = { 
                id: Date.now(), 
                descripcion: desc, 
                cantidad: cant, 
                valor: val 
            };
            storage.items.push(item);
            
            // Agregar a recientes
            storage.itemsRecientes.unshift({ 
                descripcion: desc, 
                valor: val 
            });
            
            // Mantener solo los √∫ltimos 5 items
            if (storage.itemsRecientes.length > 5) {
                storage.itemsRecientes.pop();
            }

            guardarDatos();
            limpiarInputsItems();
            actualizarPreview();
            mostrarItemsRecientes();
            mostrarMensajeExito('‚úì Item agregado correctamente');
        }

        function limpiarInputsItems() {
            document.getElementById('itemDescripcion').value = '';
            document.getElementById('itemCantidad').value = '1';
            document.getElementById('itemValor').value = '';
        }

        function mostrarItemsRecientes() {
            if (storage.itemsRecientes.length === 0) {
                document.getElementById('recentItems').style.display = 'none';
                return;
            }
            document.getElementById('recentItems').style.display = 'block';
            const html = storage.itemsRecientes.map((item, i) => 
                `<div class="recent-item" onclick="usarItemReciente(${i})">
                    ${item.descripcion} - $${item.valor.toLocaleString('es-CL')}
                </div>`
            ).join('');
            document.getElementById('recentItemsList').innerHTML = html;
        }

        function usarItemReciente(index) {
            const item = storage.itemsRecientes[index];
            document.getElementById('itemDescripcion').value = item.descripcion;
            document.getElementById('itemValor').value = item.valor;
            document.getElementById('itemCantidad').value = '1';
        }

        function removerItem(id) {
            storage.items = storage.items.filter(item => item.id !== id);
            guardarDatos();
            actualizarPreview();
            mostrarMensajeExito('‚úì Item removido');
        }

        function limpiarFormulario() {
            if (!confirm('¬øSeguro que quieres limpiar todos los datos del presupuesto?')) return;
            
            storage.items = [];
            storage.ultimoNumeroPresupuesto++;
            storage.cliente = { 
                nombre: '', 
                empresa: '', 
                direccion: '',
                contacto: '' 
            };
            
            document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteEmpresa').value = '';
            document.getElementById('clienteDireccion').value = '';
            document.getElementById('clienteContacto').value = '';
            limpiarInputsItems();
            
            guardarDatos();
            actualizarPreview();
            mostrarMensajeExito('‚úì Presupuesto nuevo iniciado');
        }

        function actualizarPreview() {
            const preview = document.getElementById('budgetPreview');
            
            if (storage.items.length === 0) {
                preview.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>Completa los datos para generar el presupuesto</p>
                    </div>
                `;
                return;
            }

            const numeroPresupuesto = storage.ultimoNumeroPresupuesto;
            const fecha = new Date().toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const subtotal = storage.items.reduce((sum, item) => sum + (item.cantidad * item.valor), 0);
            const iva = subtotal * 0.19;
            const total = subtotal + iva;

            let html = `
                <div class="budget-preview" id="pdfContent">
                    <div class="budget-header">
                        <div>
                            <div class="budget-company">${storage.empresa.nombre}</div>
                            <div style="font-size: 12px; color: var(--color-text-secondary);">
                                ${storage.empresa.rut ? `RUT: ${storage.empresa.rut}` : ''}
                                ${storage.empresa.direccion ? `<br>${storage.empresa.direccion}` : ''}
                                ${storage.empresa.contacto ? `<br>${storage.empresa.contacto}` : ''}
                            </div>
                        </div>
                        <div class="budget-number">Presupuesto N¬∫ ${numeroPresupuesto}</div>
                    </div>

                    <div class="budget-details">
                        <div class="detail-item">
                            <div class="detail-label">Para:</div>
                            <div class="detail-value">${storage.cliente.nombre || 'No especificado'}</div>
                            ${storage.cliente.empresa ? `<div style="font-size: 12px;">${storage.cliente.empresa}</div>` : ''}
                            ${storage.cliente.direccion ? `<div style="font-size: 12px;">${storage.cliente.direccion}</div>` : ''}
                            ${storage.cliente.contacto ? `<div style="font-size: 12px;">${storage.cliente.contacto}</div>` : ''}
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fecha:</div>
                            <div class="detail-value">${fecha}</div>
                            <div class="detail-label" style="margin-top: 10px;">V√°lido por:</div>
                            <div class="detail-value">30 d√≠as</div>
                        </div>
                    </div>

                    <div class="budget-items">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripci√≥n</th>
                                    <th>Cantidad</th>
                                    <th>Valor Unit.</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            storage.items.forEach(item => {
                const itemTotal = item.cantidad * item.valor;
                html += `
                    <tr>
                        <td>${item.descripcion}</td>
                        <td>${item.cantidad}</td>
                        <td>$${item.valor.toLocaleString('es-CL')}</td>
                        <td>$${itemTotal.toLocaleString('es-CL')}</td>
                        <td><button class="btn-remove" onclick="removerItem(${item.id})">√ó</button></td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>

                    <div class="budget-totals">
                        <div class="total-row">
                            <span class="total-label">Subtotal:</span>
                            <span>$${subtotal.toLocaleString('es-CL')}</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">IVA (19%):</span>
                            <span>$${iva.toLocaleString('es-CL')}</span>
                        </div>
                        <div class="total-row" style="font-size: 18px; gap: 20px;">
                            <span class="total-label">TOTAL:</span>
                            <span>$${total.toLocaleString('es-CL')}</span>
                        </div>
                    </div>
                </div>
            `;

            preview.innerHTML = html;
            
            // Tambi√©n actualizar el contenido imprimible
            actualizarContenidoImprimible();
        }

        function actualizarContenidoImprimible() {
            if (storage.items.length === 0) return;
            
            const numeroPresupuesto = storage.ultimoNumeroPresupuesto;
            const fecha = new Date().toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const subtotal = storage.items.reduce((sum, item) => sum + (item.cantidad * item.valor), 0);
            const iva = subtotal * 0.19;
            const total = subtotal + iva;

            let html = `
                <div class="budget-preview">
                    <div class="budget-header">
                        <div>
                            <div class="budget-company">${storage.empresa.nombre}</div>
                            <div style="font-size: 12px; color: var(--color-text-secondary);">
                                ${storage.empresa.rut ? `RUT: ${storage.empresa.rut}` : ''}
                                ${storage.empresa.direccion ? `<br>${storage.empresa.direccion}` : ''}
                                ${storage.empresa.contacto ? `<br>${storage.empresa.contacto}` : ''}
                            </div>
                        </div>
                        <div class="budget-number">Presupuesto N¬∫ ${numeroPresupuesto}</div>
                    </div>

                    <div class="budget-details">
                        <div class="detail-item">
                            <div class="detail-label">Para:</div>
                            <div class="detail-value">${storage.cliente.nombre || 'No especificado'}</div>
                            ${storage.cliente.empresa ? `<div style="font-size: 12px;">${storage.cliente.empresa}</div>` : ''}
                            ${storage.cliente.direccion ? `<div style="font-size: 12px;">${storage.cliente.direccion}</div>` : ''}
                            ${storage.cliente.contacto ? `<div style="font-size: 12px;">${storage.cliente.contacto}</div>` : ''}
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fecha:</div>
                            <div class="detail-value">${fecha}</div>
                            <div class="detail-label" style="margin-top: 10px;">V√°lido por:</div>
                            <div class="detail-value">30 d√≠as</div>
                        </div>
                    </div>

                    <div class="budget-items">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripci√≥n</th>
                                    <th>Cantidad</th>
                                    <th>Valor Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            storage.items.forEach(item => {
                const itemTotal = item.cantidad * item.valor;
                html += `
                    <tr>
                        <td>${item.descripcion}</td>
                        <td>${item.cantidad}</td>
                        <td>$${item.valor.toLocaleString('es-CL')}</td>
                        <td>$${itemTotal.toLocaleString('es-CL')}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>

                    <div class="budget-totals">
                        <div class="total-row">
                            <span class="total-label">Subtotal:</span>
                            <span>$${subtotal.toLocaleString('es-CL')}</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">IVA (19%):</span>
                            <span>$${iva.toLocaleString('es-CL')}</span>
                        </div>
                        <div class="total-row" style="font-size: 18px; gap: 20px;">
                            <span class="total-label">TOTAL:</span>
                            <span>$${total.toLocaleString('es-CL')}</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('printableBudget').innerHTML = html;
        }

        function mostrarMensajeExito(mensaje) {
            const el = document.getElementById('successMessage');
            el.textContent = mensaje;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 2000);
        }

        function generarPDF() {
            if (storage.items.length === 0) {
                alert('Agrega items al presupuesto antes de generar el PDF');
                return;
            }

            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            
            // N√∫mero de presupuesto y fecha
            const fecha = new Date().toLocaleDateString('es-CL');
            doc.setFontSize(20);
            doc.text('PRESUPUESTO', pageWidth / 2, margin, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`N¬∫: ${storage.ultimoNumeroPresupuesto}`, pageWidth - margin, margin + 8, { align: 'right' });
            doc.text(`Fecha: ${fecha}`, pageWidth - margin, margin + 14, { align: 'right' });
            
            let yPos = margin + 30;
            
            // Informaci√≥n de la empresa
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(storage.empresa.nombre, margin, yPos);
            doc.setFont('helvetica', 'normal');
            yPos += 6;
            
            if (storage.empresa.rut) {
                doc.text(`RUT: ${storage.empresa.rut}`, margin, yPos);
                yPos += 5;
            }
            if (storage.empresa.direccion) {
                doc.text(`Direcci√≥n: ${storage.empresa.direccion}`, margin, yPos);
                yPos += 5;
            }
            if (storage.empresa.contacto) {
                doc.text(`Contacto: ${storage.empresa.contacto}`, margin, yPos);
                yPos += 5;
            }
            
            yPos += 10;
            
            // Informaci√≥n del cliente
            if (storage.cliente.nombre || storage.cliente.empresa) {
                doc.setFont('helvetica', 'bold');
                doc.text('CLIENTE:', margin, yPos);
                doc.setFont('helvetica', 'normal');
                yPos += 6;
                
                if (storage.cliente.nombre) {
                    doc.text(`Nombre: ${storage.cliente.nombre}`, margin, yPos);
                    yPos += 5;
                }
                if (storage.cliente.empresa) {
                    doc.text(`Empresa: ${storage.cliente.empresa}`, margin, yPos);
                    yPos += 5;
                }
                if (storage.cliente.direccion) {
                    doc.text(`Direcci√≥n: ${storage.cliente.direccion}`, margin, yPos);
                    yPos += 5;
                }
                if (storage.cliente.contacto) {
                    doc.text(`Contacto: ${storage.cliente.contacto}`, margin, yPos);
                    yPos += 5;
                }
                
                yPos += 10;
            }
            
            // Tabla de items
            const headers = [['Descripci√≥n', 'Cantidad', 'Valor Unit.', 'Total']];
            const data = storage.items.map(item => [
                item.descripcion,
                item.cantidad.toString(),
                `$${item.valor.toLocaleString('es-CL')}`,
                `$${(item.cantidad * item.valor).toLocaleString('es-CL')}`
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: headers,
                body: data,
                margin: { left: margin, right: margin },
                styles: { fontSize: 10 },
                headStyles: { fillColor: [32, 128, 144] },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 25, halign: 'right' },
                    2: { cellWidth: 35, halign: 'right' },
                    3: { cellWidth: 35, halign: 'right' }
                }
            });
            
            // Totales
            const finalY = doc.lastAutoTable.finalY + 10;
            const subtotal = storage.items.reduce((sum, item) => sum + (item.cantidad * item.valor), 0);
            const iva = subtotal * 0.19;
            const total = subtotal + iva;
            
            doc.setFontSize(11);
            doc.text(`Subtotal: $${subtotal.toLocaleString('es-CL')}`, pageWidth - margin - 70, finalY, { align: 'right' });
            doc.text(`IVA (19%): $${iva.toLocaleString('es-CL')}`, pageWidth - margin - 70, finalY + 6, { align: 'right' });
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(`TOTAL: $${total.toLocaleString('es-CL')}`, pageWidth - margin - 70, finalY + 14, { align: 'right' });
            
            // Guardar el PDF
            doc.save(`Presupuesto_${storage.ultimoNumeroPresupuesto}_${fecha.replace(/\//g, '-')}.pdf`);
            
            mostrarMensajeExito('‚úì PDF generado correctamente');
        }

        function imprimirPresupuesto() {
            if (storage.items.length === 0) {
                alert('Agrega items al presupuesto antes de imprimir');
                return;
            }
            
            // Asegurar que el contenido imprimible est√© actualizado
            actualizarContenidoImprimible();
            
            // Crear una ventana de impresi√≥n temporal
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Presupuesto N¬∫ ${storage.ultimoNumeroPresupuesto} - ${storage.empresa.nombre}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 20mm;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 0;
                            font-size: 12pt;
                            line-height: 1.4;
                            color: #000;
                        }
                        
                        .budget-preview {
                            width: 100%;
                            max-width: 210mm;
                            margin: 0 auto;
                            padding: 0;
                        }
                        
                        .budget-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 25px;
                            padding-bottom: 15px;
                            border-bottom: 2px solid #000;
                        }
                        
                        .budget-company {
                            font-weight: bold;
                            font-size: 16pt;
                            color: #000;
                        }
                        
                        .budget-number {
                            background: #208090;
                            color: white;
                            padding: 8px 12px;
                            border-radius: 4px;
                            font-weight: bold;
                            font-size: 12pt;
                        }
                        
                        .budget-details {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 30px;
                        }
                        
                        .detail-item {
                            font-size: 11pt;
                        }
                        
                        .detail-label {
                            color: #666;
                            margin-bottom: 4px;
                        }
                        
                        .detail-value {
                            font-weight: bold;
                            color: #000;
                        }
                        
                        .table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 25px 0;
                            font-size: 11pt;
                        }
                        
                        .table th {
                            background: #208090;
                            color: white;
                            font-weight: bold;
                            padding: 10px;
                            text-align: left;
                        }
                        
                        .table td {
                            padding: 10px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        .table tbody tr:nth-child(even) {
                            background-color: #f8f9fa;
                        }
                        
                        .budget-totals {
                            background: #f8f9fa;
                            color: #000;
                            padding: 20px;
                            margin-top: 30px;
                            border: 2px solid #208090;
                            border-radius: 4px;
                        }
                        
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-weight: bold;
                        }
                        
                        .total-row:last-child {
                            font-size: 14pt;
                            margin-top: 12px;
                            padding-top: 12px;
                            border-top: 2px solid #208090;
                        }
                        
                        .conditions {
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 1px solid #ddd;
                            font-size: 10pt;
                            color: #666;
                        }
                        
                        /* Control de saltos de p√°gina */
                        .budget-header, .budget-totals {
                            page-break-inside: avoid;
                        }
                        
                        .table {
                            page-break-inside: auto;
                        }
                        
                        .table tr {
                            page-break-inside: avoid;
                        }
                        
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${document.getElementById('printableBudget').innerHTML}
                    <script>
                        // Imprimir autom√°ticamente cuando se carga la ventana
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                // Cerrar la ventana despu√©s de imprimir
                                setTimeout(function() {
                                    window.close();
                                }, 500);
                            }, 250);
                        };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Incrementar el n√∫mero de presupuesto
            storage.ultimoNumeroPresupuesto++;
            guardarDatos();
            actualizarPreview();
            
            mostrarMensajeExito('‚úì Presupuesto enviado a impresi√≥n');
        }

        // Cargar datos al iniciar
        window.addEventListener('load', () => {
            cargarDatos();
            
            // Inicializar PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(() => {
                    console.log('Aplicaci√≥n lista para funcionar offline');
                });
            }
        });
    </script>
</body>
</html>